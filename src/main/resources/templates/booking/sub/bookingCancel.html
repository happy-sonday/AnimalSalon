<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
<meta charset="UTF-8">
<meta id="_csrf" name="_csrf" th:content="${_csrf.token}"/>
<meta id="_csrf_header" name="_csrf_header" th:content="${_csrf.headerName}"/>
<title>예약취소</title>
<link rel="stylesheet" th:href="@{'/static/css/main/bootstrap.min.css'}">
</head>
<body>

	<div align="center">
		<div>
			환불규정내용 들어갈 예정
		</div>
		<select name="reasonForCancel" id="reasonForCancel">
			<option value="x" disabled="disabled" selected="selected">취소 사유를 선택해주세요.</option>
			<option value="예약 실수">예약 실수</option>
			<option value="다른 용무">다른 용무</option>
			<option value="기타">기타</option>
		</select>
		<input type="hidden" id="bCode" th:value="${view.bCode}">
		<input type="hidden" id="merchantUid" th:value="${view.merchantUid}">
		<input type="hidden" id="price" th:value="${view.bPrice}">
		<button onclick="cancelPay()">예약 취소[환불]</button>
	</div>

	<script th:src="@{/static/js/jquery-3.5.1.min.js}" type="text/javascript"></script>
	<script th:src="@{/static/js/bootstrap.bundle.min.js}" charset="UTF-8"></script>
	<script th:src="@{/static/js/booking/bookingHome.js}" type="text/javascript"></script>
	
 <!-- jQuery CDN -->
<script src="https://code.jquery.com/jquery-3.3.1.js"
	integrity="sha256-2Kok7MbOyxpgUVvAk/HJ2jigOSYS2auK4Pfzbm7uH60="
	crossorigin="anonymous"></script>
<script>
	function cancelPay() {
		var token = $("meta[name='_csrf']").attr("content");
		var header = $("meta[name='_csrf_header']").attr("content");
		
		var bCode = $("#bCode").val();
		
		var merchantUid = $("#merchantUid").val();
		var cancelReason =  $("#reasonForCancel option:selected").val();
		var bPrice = $("#price").val()*1;
		
		//console.log(merchantUid + "__" + cancelReason + "__" + bPrice);
		//console.log(Number.isInteger(bPrice)); // true
		jQuery.ajax({
			url: "/cndsalon/payments/cancel",
			method: "post",
			dataType: "json",
			contentType: "application/json",
			async : false,
			data: JSON.stringify({
				merchant_uid: merchantUid,																		// 주문번호
				amount: bPrice,																							// 환불금액
				reason: cancelReason 																				// 환불사유
			}),
			beforeSend : function(xhr){
				xhr.setRequestHeader(header, token);
			}
		}).done(function(result){
				
				//console.log("예약코드 : " + bCode);
				var data = JSON.stringify({
					bStatus : "2",
					bCancelReason : cancelReason
				});
				//console.log(result);
				$.ajax({
					contentType : 'application/json; charset=utf-8',
					url : '/cndsalon/bookinghome/bookings/' + bCode,
					type: 'put',
					dataType : 'json',
					data : data,
					beforeSend : function(xhr){
					xhr.setRequestHeader($("meta[name='_csrf_header']").attr("content"), $("meta[name='_csrf']").attr("content"));
					}
				});
				alert("환불이 완료되었습니다.");
				opener.parent.location='/cndsalon/bookinghome/status/all'
				close();
		}).fail(function(err){
				alert("환불이 실패하였습니다.\n Error : " + err);
			});
		}
	</script>
</body>
</html>